# 谷歌浏览器关闭自动更新
**Google Chrome 强制自动更新问题及解决方案**

---

### **问题描述**
与 Firefox 官方提供禁用自动更新配置不同，Google Chrome 及其衍生浏览器（如 Microsoft Edge 及各类国产浏览器）不仅未提供禁用自动更新的配置选项，还强制自动更新，且更新行为难以控制。即使用户通过变通方法屏蔽自动更新，仍会持续收到“软件已过期”的提示。

---

### **适用版本**
- 本文以 Chrome 88 版本为例，已验证至 105 版本可用。
- 未来新版本可能存在变更，若方法失效欢迎反馈，笔者将及时修正。

---

### **Mac 版解决方案**

#### **自动更新机制**

通过以下进程及域名实现：
- **进程路径**：
```bash
~/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/GoogleSoftwareUpdateAgent.app
~/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle/Contents/Helpers/ksfetch
/Applications/Google Chrome.app`（通过 `ksfetch`）
```
- **检测域名**：
  - `tools.google.com`
  - `update.googleapis.com`

#### **解决方案**

1. **删除进程并设置只读权限**  
   执行以下终端命令：
   ```bash
   # 删除更新程序
   rm -rf ~/Library/Google/GoogleSoftwareUpdate/GoogleSoftwareUpdate.bundle
   
   # 设置目录为系统级只读
   sudo chflags schg ~/Library/Google/GoogleSoftwareUpdate
   # 恢复命令：sudo chflags noschg ~/Library/Google/GoogleSoftwareUpdate
   
   # 若为全新系统，可手动创建目录并设置只读
   mkdir -p ~/Library/Google/GoogleSoftwareUpdate
   sudo chflags schg ~/Library/Google/GoogleSoftwareUpdate
   ```

2. **编辑 hosts 文件屏蔽域名（亲测可用！）**  
   在 `/etc/hosts` 中添加：
   ```
   127.0.0.1 update.googleapis.com
   127.0.0.1 tools.google.com
   ```

3. **使用防火墙屏蔽进程网络访问**（可选）  
   推荐使用 Little Snitch，屏蔽以下进程：
   - `GoogleSoftwareUpdateAgent.app`
   - `ksfetch`
   - `Google Chrome.app`（通过 `ksfetch`）

#### **部署策略（企业环境）**
通过 MDM 部署策略文件，或执行以下命令（单机测试无效）：
```bash
sudo mkdir /Library/Managed\ Preferences
sudo defaults write /Library/Managed\ Preferences/com.google.Keystone updatePolicies -dict UpdateDefault -int 3
sudo defaults write /Library/Managed\ Preferences/com.google.Keystone updatePolicies -dict-add ComponentUpdatesEnabled -bool false
```

---

### **Linux 版解决方案**

#### **通过包管理器禁用更新**
- **Debian/Ubuntu**：
  ```bash
  sudo apt-mark hold google-chrome-stable
  # 恢复：sudo apt-mark unhold google-chrome-stable
  ```
- **Redhat/CentOS**：
  ```bash
  echo 'exclude=google-chrome-stable' >> /etc/yum.conf
  # 恢复：编辑 /etc/yum.conf 删除对应行
  ```

#### **通过策略禁用更新**
1. **关闭浏览器更新**：
   - 创建空配置：  
     ```bash
     sudo touch /etc/default/google-chrome
     ```
   - 添加内容：`repo_add_once=false`

2. **关闭组件更新**（可选）：
   - 创建 `component_update.json` 文件至 `/etc/opt/chrome/policies/managed/`：
     ```json
     {
       "ComponentUpdatesEnabled": false
     }
     ```

---

### **Windows 版解决方案**

#### **自动更新机制**
- **更新组件**：
  - 服务：`gupdate`、`gupdatem`、`GoogleChromeElevationService`
  - 计划任务：`GoogleUpdateTaskMachineCore`、`GoogleUpdateTaskMachineUA`
- **安装路径**：
  - 系统版：`C:\Program Files\Google\Chrome\Application\`
  - 用户版：`C:\Users\<用户名>\AppData\Local\Google\Chrome\Application\`

#### **解决方案**
1. **手动禁用**：
   - 停止并删除相关服务与计划任务。
   - 删除 `C:\Program Files (x86)\Google\Update\` 目录。

2. **PowerShell 脚本**  
   保存以下脚本为 `disable-chrome-auto-update.ps1`，右键“使用 PowerShell 运行”：
   ```powershell
   if ([Environment]::Is64BitOperatingSystem -eq "True") {
        #Write-Host "64-bit OS"
        $PF=${env:ProgramFiles(x86)}
    }
    else {
        #Write-Host "32-bit OS"
        $PF=$env:ProgramFiles
    }
    
    if ($(Test-Path "$env:ProgramFiles\Google\Chrome\Application\chrome.exe") -eq "true") {
        # 结束进程
        taskkill /im chrome.exe /f
        taskkill /im GoogleUpdate.exe /f
        # Google Chrome 更新服务 (sysin)
        #这里也可以使用 sc.exe stop "service name"
        Stop-Service -Name "gupdate"
        Stop-Service -Name "gupdatem"
        Stop-Service -Name "GoogleChromeElevationService"
        # Windows 10 默认 PS 版本 5.1 没有 Remove-Service 命令
        # This cmdlet was added in PS v6. See https://docs.microsoft.com/en-us/powershell/scripting/whats-new/what-s-new-in-powershell-core-60?view=powershell-6#cmdlet-updates.
        #Remove-Service -Name "gupdate"
        #Remove-Service -Name "gupdatem"
        #Remove-Service -Name "GoogleChromeElevationService"
        # sc 在 PowerShell 中是 Set-Content 别名，所以要使用 sc.exe 否则执行后无任何效果
        sc.exe delete "gupdate"
        sc.exe delete "gupdatem"
        sc.exe delete "GoogleChromeElevationService"
        # 任务计划企业版
        #schtasks.exe /Delete /TN \GoogleUpdateBrowserReplacementTask /F
        #schtasks.exe /Delete /TN \GoogleUpdateTaskMachineCore /F
        #schtasks.exe /Delete /TN \GoogleUpdateTaskMachineUA /F
        Get-ScheduledTask -taskname GoogleUpdate* | Unregister-ScheduledTask -Confirm: $false
        # 移除更新程序
        Remove-Item "$PF\Google\Update\" -Recurse -Force
        Write-Output "Disable Google Chrome Enterprise x64 Auto Update Successful!"
    }
    elseif ($(Test-Path "${env:ProgramFiles(x86)}\Google\Chrome\Application\chrome.exe") -eq "true") {
        # 结束进程
        taskkill /im chrome.exe /f
        taskkill /im GoogleUpdate.exe /f
        # 删除 Google Chrome 更新服务
        #这里也可以使用 sc.exe stop "service name"
        Stop-Service -Name "gupdate"
        Stop-Service -Name "gupdatem"
        Stop-Service -Name "GoogleChromeElevationService"
        # Windows 10 默认 PS 版本 5.1 没有 Remove-Service 命令，糟糕！
        # This cmdlet was added in PS v6. See https://docs.microsoft.com/en-us/powershell/scripting/whats-new/what-s-new-in-powershell-core-60?view=powershell-6#cmdlet-updates.
        #Remove-Service -Name "gupdate"
        #Remove-Service -Name "gupdatem"
        #Remove-Service -Name "GoogleChromeElevationService"
        # sc 在 PowerShell 中是 Set-Content 别名，所以要使用 sc.exe 否则执行后无任何效果
        sc.exe delete "gupdate"
        sc.exe delete "gupdatem"
        sc.exe delete "GoogleChromeElevationService"
        # 删除任务计划
        #schtasks.exe /Delete /TN \GoogleUpdateBrowserReplacementTask /F
        #schtasks.exe /Delete /TN \GoogleUpdateTaskMachineCore /F
        #schtasks.exe /Delete /TN \GoogleUpdateTaskMachineUA /F
        Get-ScheduledTask -taskname GoogleUpdate* | Unregister-ScheduledTask -Confirm: $false
        # 移除更新程序
        Remove-Item "$PF\Google\Update\" -Recurse -Force
        Write-Output "Disable Google Chrome Enterprise x86 Auto Update Successful!"
    }
    else {
        Write-Output "No Google Chrome Enterprise Installation Detected!"
    }
   ```
   *（脚本功能：结束进程、禁用服务、删除计划任务及更新文件）*

3. **组策略配置**（企业域环境）  
   通过下载管理模板并部署组策略实现。